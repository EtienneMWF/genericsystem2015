<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<script src="http://code.jquery.com/jquery-2.2.0.min.js"></script>

<script type="text/javascript">
	var wsocket;
	var serviceLocation = "ws://127.0.0.1:8082/Engine";
	const 
		MESSAGE_DO_ADD = 'A',
		MESSAGE_DO_REMOVE = 'R',
		MESSAGE_DO_UPDATE = 'U',
		ELEMENT_TYPE = 'E'; //element 
	
//-------------------------------------------------------------	
	function getSubString(bytes, start, end) {
		subString = '';
		for (var i = start; i < end; i++) {
			subString += String.fromCharCode(bytes[i]);
		}
		return subString;
	}
	
//-------------------------------------------------------------
	function onMessageReceived(evt) {
		var bytes = new Uint8Array(evt.data), 
		messageType = getSubString(bytes, 0, 1);
		
		switch(messageType) {
		 	case MESSAGE_DO_ADD:
				addElement(bytes);
		        break;
		    case MESSAGE_DO_REMOVE:
				removeElement(bytes);
		        break;
		    case MESSAGE_DO_UPDATE:
				updateElement(bytes);
		        break;
		    default:
		        alert("message d'erreur");
		}
	}

//-------------------------------------------------------------
	function addElement(bytes){
		var
		length = bytes.length, 
		parentId =  getSubString(bytes, 1, 11), 
		nodeId = getSubString(bytes, 11, 21),
		tagHtml = getSubString(bytes, 21, length);	
	
		var root = document.getElementById("root");
		var parent = document.getElementById(parentId);
		if (parent == null) {
			parent = createElement(root,tagHtml,parentId);
		}
	
		var nodeType = nodeId.charAt(0);
		var elt = document.getElementById(nodeId);
		if (nodeType == 'c') {
			elt = createElement(parent,tagHtml,nodeId);
		} else {
			elt = document.createTextNode(tagHtml);
			parent.insertBefore(elt, null);
		}
		
		if (parent.type = 'input')
			parent.value = tagHtml;
	}

//-------------------------------------------------------------
	function createElement(parent,tag,id){
		var elt = document.createElement(tag);
		elt.setAttribute("id", id);
		
		if(tag=="button")
			elt.onclick = function click(){sendMessageAction(id)};
			
		if(tag == "input")
		{
			elt.setAttribute("type", "text");	
			elt.onblur = function onblurInput(){sendMessageAction(id)}
		}
		
		parent.insertBefore(elt, null);
		return elt;
	}
	
//-------------------------------------------------------------
	function updateElement(bytes){
		var
		length = bytes.length, 
		nodeId = getSubString(bytes, 1, 11),
		tagHtml = getSubString(bytes, 11, length);
		var elt = document.getElementById(nodeId);
		
		alert("update")
	}
	
//-------------------------------------------------------------
	function removeElement(bytes){
		var 
		length = bytes.length, 
		nodeId = getSubString(bytes, 1, 11);
		var elt = document.getElementById(nodeId);
		elt.parentNode.removeChild(elt);
	}
	
//-------------------------------------------------------------	
	function sendMessageAction(id){
		var methodId = new Uint32Array(1);
		methodId[0] = 19;
		var opId = new Uint32Array(1);
		opId[0] = id.substr(1,id.length);
		wsocket.send(new Blob([ methodId, opId ]));
	}
	
//-------------------------------------------------------------	
	function connect() {
		wsocket = new WebSocket(serviceLocation);
		wsocket.binaryType = "arraybuffer";
		wsocket.onmessage = onMessageReceived;
	}
	
//-------------------------------------------------------------
	function leave() {
		wsocket.close();
	}

	$(document).ready(function() {
		connect();
	});

	function sendMessage() {
		var methodId = new Uint32Array(1);
		methodId[0] = 19;
		var opId = new Uint32Array(1);
		opId[0] = 12789;
		wsocket.send(new Blob([ methodId, opId ]));
	}
</script>
</head>
<body id="root">

</body>
</html>
