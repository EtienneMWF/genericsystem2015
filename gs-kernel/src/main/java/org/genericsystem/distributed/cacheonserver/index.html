<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<script src="http://code.jquery.com/jquery-2.2.0.min.js"></script>
<LINK rel=stylesheet type="text/css" href="style.css">
<script type="text/javascript">
	var wsocket;
	var serviceLocation = "ws://127.0.0.1:8082/Engine";
	const 
		MESSAGE_DO_ADD = 'A',
		MESSAGE_DO_REMOVE = 'R',
		MESSAGE_DO_UPDATE = 'U',
		ELEMENT_TYPE = 'E'; //element 
	
//-------------------------------------------------------------	
	function getSubString(bytes, start, end) {
		subString = '';
		for (var i = start; i < end; i++) {
			subString += String.fromCharCode(bytes[i]);
		}
		return subString;
	}
	
//-------------------------------------------------------------
	function onMessageReceived(evt) {
		var bytes = new Uint8Array(evt.data);
		var message = jQuery.parseJSON(getSubString(bytes,0,bytes.length));
		messageType = message.msg_type;
		
		switch(messageType) {
		 	case MESSAGE_DO_ADD:
		 		addElement(message);
		        break;
		    case MESSAGE_DO_REMOVE:
				removeElement(message);
		        break;
		    case MESSAGE_DO_UPDATE:
				updateElement(message);
		        break;
		    default:
		        alert("message d'erreur");
		}
	}

//-------------------------------------------------------------
	function addElement(message){
		var
		parentId =  message.parentId, 
		nodeId = message.nodeId,
		tagHtml = message.tagHtml,
		textContentValue = message.textContent;	
	
		var root = document.getElementById("root");
		var parent = document.getElementById(parentId);
		if (parent == null) {
			parent = createElement(root,message);
		}
	
		elt = createElement(parent,message);
		
	}

//-------------------------------------------------------------
	function createElement(parent,message){
		var
		
		id = message.nodeId,
		tag = message.tagHtml,
		textContentValue = message.textContent;	
		styleClass=message.styleClass;
		var elt = document.createElement(tag);
		
		elt.setAttribute("id", id);
		

	
		elt.textContent = textContentValue;
		
		if(tag=="button" || tag=="a") {
			elt.onclick = function click(){sendMessageAction(elt)};
			if(tag=="a") {
				elt.setAttribute("href", "#");
			}
		} else 	if(tag == "input") 	{
			elt.setAttribute("type", message.type);	
			if(message.type='text')
			{
				elt.value = textContentValue;
				elt.onkeyup = function keyup(e){
					var code = (e.keyCode ? e.keyCode : e.which)
					if(code== 13) {
						sendMessageAction(elt);
						elt.value = "";
					}
					sendMessageKeyup(elt)
				}
			}
			
			if(elt.getAttribute("type") == 'checkbox'){
				elt.onchange=function change(){
					sendMessageCheckBoxValue(elt);
				}
				elt.checked = message["checked"];
			}
			
		}
		
		for(var i=0;i<styleClass.length;i++)
			elt.className += " " + styleClass[i];
		
		parent.insertBefore(elt, null);
		return elt;
	}
//-------------------------------------------------------------
	function sendMessageCheckBoxValue(elt){
		wsocket.send(JSON.stringify({msg_type:"U",nodeId: elt.id,tag: elt.tagName,eltType:"checkbox",checked : elt.checked}));
	}
//-------------------------------------------------------------
	function updateElement(message){
		var elt = document.getElementById(message.nodeId);
		if(elt == null) 
			return;
		
		updateText(message, elt);
		updateClass(message, elt);
	}
	
	function updateText(message, elt) {
		if(typeof message.textContent === 'undefined')
			return;
		
		if(elt.type == "input") {
			elt.value = message.textContent;
			return;
		}
		
		elt.textContent = message.textContent;
		
	}
	
	function updateClass(message, elt) {
		if (typeof message.styleClass === 'undefined')
			return;
		
		elt.className = "";
		message.styleClass.forEach(function(element, index, array) {
			elt.className += " " + element;
		});
	}
	
//-------------------------------------------------------------
	function removeElement(message){
		var 
		nodeId = message.nodeId;
		var elt = document.getElementById(nodeId);
		if(elt!=null)
			elt.parentNode.removeChild(elt);
	}
	
//-------------------------------------------------------------
	function sendMessageKeyup(elt){
		var toto = JSON.stringify({msg_type:"U",nodeId: elt.id,tag: elt.tagName,eltType:"text",textContent:elt.value});
		wsocket.send(toto);
	}

//-------------------------------------------------------------	
	function sendMessageAction(elt){
		wsocket.send(JSON.stringify({msg_type:"A",nodeId: elt.id,tag: elt.tagName}));
	}
	
//-------------------------------------------------------------	
	function connect() {
		wsocket = new WebSocket(serviceLocation);
		wsocket.binaryType = "arraybuffer";
		wsocket.onmessage = onMessageReceived;
	}
	
//-------------------------------------------------------------
	function leave() {
		//wsocket.close();
	}

	$(document).ready(function() {
		connect();
	});

	function sendMessage() {
		var methodId = new Uint32Array(1);
		methodId[0] = 19;
		var opId = new Uint32Array(1);
		opId[0] = 12789;
		wsocket.send(new Blob([ methodId, opId ]));
	}
</script>
</head>
<body id="root">

</body>
</html>
